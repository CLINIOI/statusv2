<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Каталог недвижимости</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- noUiSlider CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.6.1/dist/nouislider.min.css" />
  <link rel="stylesheet" href="test.css">
   <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/footer.css" />
 <link rel="stylesheet" href="css/top_img-header.css" /><!-- Swiper CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<link rel="icon" href="assets/icon/favicon2.ico" type="image/x-icon" />
<link rel="icon" href="assets/icon/favicon2.png"    type="image/png" />
<link rel="apple-touch-icon" href="assets/icon/favicon2.png" />
  <style>
   
  </style>
</head>
<body>
    <header    class="site-header " id="siteHeader">
    <div class="container">
      <!-- 1. ЛОГОТИП -->
      <a href="" class="logo">
  <img class="icon-top" src="assets/icon/unnamed-2.png">
</a>

      <button class="nav-toggle" id="navToggle" aria-label="Открыть меню">
        <span class="burger"></span>
      </button>

      <!-- 3. NAV (overlay-меню), по умолчанию скрытое -->
      <nav class="nav" id="siteNav">
        <!-- 3.1 КНОПКА-КРЕСТИК (закрыть меню), видна только когда overlay открыт -->
        <button class="nav-close" id="navClose" aria-label="Закрыть меню">
          <span class="close-icon"></span>
        </button>

        <!-- 3.2 ПУНКТЫ МЕНЮ -->
        <ul>
          <li><a href="./index.html">Главная</a></li>
          <li><a href="./index.html#2">Услуги</a></li>
          <li><a href="./index.html#3">Соц.Сети</a></li>
          <li><a href="./index.html#4">Преимущества</a></li>
          <li><a href="./index.html#5">Контакты</a></li>
             <li><a href="./index.html#6">Отзывы</a></li>
                <li><a href="#7">Связь</a></li><li><a href="./test2.html">Каталог </a></li>
        </ul>
      </nav>
    </div>
  </header>
  <div class="container my-5">
    <button id="filter-open" class="btn btn-secondary mb-4">Фильтр</button>
    <div id="catalog" class="catalog"></div>
  </div>

  <!-- Детали объекта -->
  <div class="modal-wrapper" id="modal-detail">
    <div class="modal-card shadow-sm">
      <button type="button" class="close-btn" id="detail-close">&times;</button>
     <div class="image-wrapper">
  <div class="swiper detailSwiper">
    <div class="swiper-wrapper" id="detail-swiper-wrapper"></div>
    <div class="swiper-pagination"></div>
  </div>
</div>

      <div class="content d-flex flex-column p-4">
        <div class="d-flex justify-content-between align-items-baseline mb-3">
          <h2 id="detail-title"></h2><span id="detail-price"></span>
        </div>
        <p id="detail-desc" class="mb-4"></p>
        <div class="details-grid mb-4" id="detail-info"></div>
      <div class="map-block mb-4" id="map"></div>

        <div class="buttons d-flex gap-2 mt-auto">
          <button class="btn btn-dark flex-fill">Связаться</button>
          <button class="btn btn-outline-dark flex-fill">Запланировать просмотр</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Фильтр -->
  <div class="modal-wrapper" id="modal-filter">
    <div class="modal-card shadow-sm">
      <button type="button" class="close-btn" id="filter-close">&times;</button>
      <div class="filter-block">
        <div class="filter-panel">
          <h4 class="filter-title">Фильтр объектов</h4>
          <form id="filter-form" class="filter-form d-flex flex-column">
            <!-- Валюта -->
            <div class="form-group mb-3">
              <label class="form-label">Валюта</label>
              <select id="currency" class="form-select">
                <option value="">Любая</option>
              </select>
            </div>
            <!-- Цена -->
            <div class="form-group mb-3">
              <label class="form-label">Цена</label>
              <div id="price-slider" class="slider"></div>
            </div>
            <!-- Площадь -->
            <div class="form-group mb-3">
              <label class="form-label">Площадь (м²)</label>
              <div id="area-slider" class="slider"></div>
            </div>
            <!-- Комнат -->
            <div class="form-group mb-3">
              <label class="form-label">Комнат (мин)</label>
              <input type="number" id="rooms-min" class="form-control" placeholder="0">
            </div>
            <!-- Тип объекта -->
            <div class="form-group mb-3">
              <label class="form-label">Тип объекта</label>
              <select id="ptype" class="form-select">
                <option value="">Любой</option>
              </select>
            </div>
            <!-- Район -->
            <div class="form-group mb-3">
              <label class="form-label">Район</label>
              <select id="district" class="form-select">
                <option value="">Любой</option>
              </select>
            </div>
            <!-- Тип ванной -->
            <div class="form-group mb-3">
              <label class="form-label">Тип санузла</label>
              <select id="bathroom-type" class="form-select">
                <option value="">Любой</option>
              </select>
            </div>
            <!-- Балкон -->
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="balcony">
              <label class="form-check-label" for="balcony">Балкон</label>
            </div>
            <!-- Ремонт -->
            <div class="form-group mb-3">
              <label class="form-label">Ремонт</label>
              <select id="repair" class="form-select">
                <option value="">Любой</option>
              </select>
            </div>
            <!-- Дата создания -->
            <div class="form-group mb-3">
              <label class="form-label">Добавлено с</label>
              <div class="d-flex gap-2">
                <input type="date" id="date-from" class="form-control">
                <input type="date" id="date-to" class="form-control">
              </div>
            </div>
            <!-- Кнопки -->
            <div class="mt-auto d-flex gap-2">
              <button type="button" id="filter-reset" class="btn btn-outline-secondary flex-fill">Сбросить</button>
              <button type="submit" class="btn btn-primary flex-fill">Применить</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <footer data-aos="fade-up" class="footer bg-dark text-light py-5">
  <div class="container-footer">
    <div class="row">
      <div class="col-md-4">
       <a href="" class="logo">
  <img class="icon-top" src="assets/icon/unnamed-2.png">
</a>

        <p>
          Какова польза ваших звёзд и деревьев, вашего рассвета и ветра, если они не входят в нашу повседневную жизнь?
        </p>
      </div>
      <div class="col-md-4">
        <p>Большая Магистральная ул., 28, Донецк, Донецкая область, 83000</p>
        <p>Тел.:  +7 949 330 6746</p>
        <p>Почта: example@gmail.com</p>
      </div>
      <div class="col-md-2">
        <ul class="list-unstyled">
          <li><a href="#1">Главная</a></li>
          <li><a href="#2">Услуги</a></li>
          <li><a href="#3">Соц.Сети</a></li>
          <li><a href="#4">Преимущества</a></li>
          <li><a href="#5">Контакты</a></li>
          <li><a href="#6">Отзывы</a></li>
          <li><a href="#7">Связь</a></li>
        </ul>
      </div>
      <div class="col-md-2">
        <ul class="list-unstyled ">
          <li>
            <a href="#" class="text-light text-decoration-none">Facebook</a>
          </li>
          <li>
            <a href="#" class="text-light text-decoration-none">Instagram</a>
          </li>
          <li>
            <a href="#" class="text-light text-decoration-none">Twitter</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</footer>
<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/nouislider@15.6.1/dist/nouislider.min.js"></script>
<script>
  let PROPERTIES = [];

  function formatDate(iso) {
    return new Date(iso).toLocaleDateString('ru-RU');
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const catalog        = document.getElementById('catalog');
    const detailModal    = document.getElementById('modal-detail');
    const filterModal    = document.getElementById('modal-filter');
    const filterForm     = document.getElementById('filter-form');
    const priceSlider    = document.getElementById('price-slider');
    const areaSlider     = document.getElementById('area-slider');

    // Загрузка данных
    const res = await fetch('/data/properties.json');
    PROPERTIES = res.ok ? await res.json() : [];

    // Заполняем селекты
    const unique = arr => [...new Set(arr.filter(Boolean))];
    const fillOptions = (values, selectId) => {
      const sel = document.getElementById(selectId);
      unique(values).forEach(v => {
        const o = document.createElement('option');
        o.value = v; o.textContent = v;
        sel.append(o);
      });
    };
    fillOptions(PROPERTIES.map(p => p.currency),       'currency');
    fillOptions(PROPERTIES.map(p => p.propertyType),   'ptype');
    fillOptions(PROPERTIES.map(p => p.location.district),'district');
    fillOptions(PROPERTIES.map(p => p.specs.bathroomType),'bathroom-type');
    fillOptions(PROPERTIES.map(p => p.specs.repair),   'repair');

    // Слайдеры цены и площади
    const prices = PROPERTIES.map(p => p.price || 0);
    const areas  = PROPERTIES.map(p => p.specs.area.total || 0);
    noUiSlider.create(priceSlider, {
      start: [Math.min(...prices), Math.max(...prices)],
      connect: true, range: { min: Math.min(...prices), max: Math.max(...prices) },
      tooltips: [true, true], format: { to: v => Math.round(v), from: v => +v }
    });
    noUiSlider.create(areaSlider, {
      start: [Math.min(...areas), Math.max(...areas)],
      connect: true, range: { min: Math.min(...areas), max: Math.max(...areas) },
      tooltips: [true, true], format: { to: v => Math.round(v), from: v => +v }
    });

    // Рендер списка и инициализация Swiper’ов
    function renderCard(prop) {
      const imgs = prop.images?.length
        ? prop.images.map(src => `<div class="swiper-slide"><img src="/${src}" class="w-100 rounded"></div>`).join('')
        : '<div class="swiper-slide"><img src="img/placeholder.jpg" class="w-100 rounded"></div>';
      const info = [];
      if (prop.location.district)      info.push(['Адрес', prop.location.address]);
      if (prop.specs.rooms != null)    info.push(['Комнат', prop.specs.rooms]);
      if (prop.specs.bathroomType)     info.push(['Санузел', prop.specs.bathroomType]);
      if (prop.specs.area.total)       info.push(['Площадь', `${prop.specs.area.total} м²`]);
      if (prop.specs.floor != null && prop.specs.totalFloors)
                                        info.push(['Этаж', `${prop.specs.floor}/${prop.specs.totalFloors}`]);
      const htmlInfo = info.map(i => `<div><strong>${i[0]}:</strong> ${i[1]}</div>`).join('');
      return `
        <div class="catalog-item row gx-0 mb-4 p-3 shadow-sm rounded-3">
          <div class="col-md-5 ">
            <div class="swiper mySwiper">
              <div class="swiper-wrapper">${imgs}</div>
              <div class="swiper-pagination"></div>
            </div>
          </div>
          <div class="col-md-6 d-flex m-3  flex-column">
            <div class="d-flex justify-content-between mb-2">
              <h3>${prop.title || prop.propertyType}</h3>
              <span>${prop.price?.toLocaleString('ru-RU') || 'По запросу'} ${prop.currency || ''}</span>
            </div>
            <div class="details-grid mb-2">${htmlInfo}</div>
            <div class="mt-auto text-end">
              <button class="btn btn-outline-primary detail-btn" data-id="${prop.id}">Подробнее</button>
            </div>
          </div>
        </div>`;
    }

    function initSwipers(root = document) {
      root.querySelectorAll('.mySwiper').forEach(el => {
        new Swiper(el, {
          loop: true,
          pagination: { el: el.querySelector('.swiper-pagination'), clickable: true }
        });
      });
    }

    function renderList(list) {
      catalog.innerHTML = list.map(renderCard).join('');
      initSwipers(catalog);
      catalog.querySelectorAll('.detail-btn').forEach(btn => {
        btn.onclick = e => {
          const id = +e.currentTarget.dataset.id;
          const p  = PROPERTIES.find(x => x.id === id);
          if (p) openDetail(p);
        };
      });
    }

    renderList(PROPERTIES);

    // Открыть/закрыть фильтр
    document.getElementById('filter-open').onclick  = () => filterModal.style.display = 'flex';
    document.getElementById('filter-close').onclick = () => filterModal.style.display = 'none';
    filterModal.onclick = e => { if (e.target === filterModal) filterModal.style.display = 'none'; };

    // Сброс и применение фильтра
    document.getElementById('filter-reset').onclick = () => {
      filterForm.reset();
      renderList(PROPERTIES);
      filterModal.style.display = 'none';
    };
    filterForm.onsubmit = e => {
      e.preventDefault();
      const [minP, maxP] = priceSlider.noUiSlider.get().map(Number);
      const [minA, maxA] = areaSlider.noUiSlider.get().map(Number);
      const roomsMin     = Number(document.getElementById('rooms-min').value) || 0;
      const vals = {
        currency:       document.getElementById('currency').value,
        ptype:          document.getElementById('ptype').value,
        district:       document.getElementById('district').value,
        bathroomType:   document.getElementById('bathroom-type').value,
        balconyReq:     document.getElementById('balcony').checked,
        repair:         document.getElementById('repair').value,
        dateFrom:       document.getElementById('date-from').value,
        dateTo:         document.getElementById('date-to').value
      };
      const matched = PROPERTIES.filter(p => {
        if (p.price < minP || p.price > maxP) return false;
        const area = p.specs.area.total || 0;
        if (area < minA || area > maxA) return false;
        if (p.specs.rooms < roomsMin) return false;
        if (vals.currency    && p.currency        !== vals.currency)    return false;
        if (vals.ptype       && p.propertyType    !== vals.ptype)       return false;
        if (vals.district    && p.location.district!== vals.district)   return false;
        if (vals.bathroomType&& p.specs.bathroomType!== vals.bathroomType) return false;
        if (vals.balconyReq  && !p.specs.balcony)                    return false;
        if (vals.repair      && p.specs.repair      !== vals.repair)      return false;
        if (vals.dateFrom    && new Date(p.createdAt) < new Date(vals.dateFrom)) return false;
        if (vals.dateTo      && new Date(p.createdAt) > new Date(vals.dateTo))   return false;
        return true;
      });
      const others = PROPERTIES.filter(p => !matched.includes(p));
      catalog.innerHTML = [
        ...matched.map(renderCard),
        '<div class="separator">Другие объекты</div>',
        ...others.map(renderCard)
      ].join('');
      initSwipers(catalog);
      filterModal.style.display = 'none';
    };

    // Открыть детали и инициализировать карту
function openDetail(prop) {
  document.getElementById('detail-title').textContent = prop.title || '';
  document.getElementById('detail-price').textContent = prop.price
    ? `${prop.price.toLocaleString('ru-RU')} ${prop.currency}` : 'По запросу';
  document.getElementById('detail-desc').textContent = prop.description || '';

  const infoArr = [
    prop.specs.rooms != null       && ['Комнат', prop.specs.rooms],
    prop.specs.bathroomType        && ['Санузел', prop.specs.bathroomType],
    prop.specs.area.total          && ['Площадь', `${prop.specs.area.total} м²`],
    prop.location.address          && ['Адрес', prop.location.address],
    (prop.specs.floor!=null && prop.specs.totalFloors) && ['Этаж', `${prop.specs.floor}/${prop.specs.totalFloors}`],
    ['Добавлено', formatDate(prop.createdAt)]
  ].filter(Boolean);

  document.getElementById('detail-info').innerHTML =
    infoArr.map(d => `<div><strong>${d[0]}:</strong> ${d[1]}</div>`).join('');

  // Слайды
  const dw = document.getElementById('detail-swiper-wrapper');
  dw.innerHTML = prop.images?.length
    ? prop.images.map(src => `<div class="swiper-slide"><img src="/${src}" class="w-100 rounded"></div>`).join('')
    : '<div class="swiper-slide"><img src="img/placeholder.jpg" class="w-100 rounded"></div>';
  if (window.detailSwiperInstance) window.detailSwiperInstance.destroy(true,true);
  window.detailSwiperInstance = new Swiper('.detailSwiper', {
    loop: true,
    pagination: { el: '.detailSwiper .swiper-pagination', clickable: true }
  });

  // === LEAFLET MAP ===
  const mapEl = document.getElementById('map');
  mapEl.innerHTML = '';
  if (window.detailMap) {
    window.detailMap.remove();
    window.detailMap = null;
  }

  const address = prop.location.address;
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
    .then(res => res.json())
    .then(data => {
      if (!data.length) throw new Error('Адрес не найден');
      const { lat, lon } = data[0];

      const map = L.map('map').setView([lat, lon], 15);
      window.detailMap = map;

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      L.marker([lat, lon]).addTo(map).bindPopup(address).openPopup();
    })
    .catch(err => {
      console.error('Ошибка геокодирования:', err);
      mapEl.textContent = 'Не удалось загрузить карту.';
    });

  detailModal.style.display = 'flex';
}

    // Закрытие модалки деталей
    document.getElementById('detail-close').onclick = () => {
      detailModal.style.display = 'none';
    };
    detailModal.onclick = e => {
      if (e.target === detailModal) detailModal.style.display = 'none';
    };
  });
</script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>



</body>
</html>